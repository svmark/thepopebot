services:
  pi-agent:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: popebot-agent
    environment:
      - BRANCH=${BRANCH:-main}
      - TASK_FILE=${TASK_FILE:-task.md}
      - ROLE=${ROLE:-worker}
      - REPO_URL=${REPO_URL}
      - GIT_USER_NAME=${GIT_USER_NAME:-popebot}
      - GIT_USER_EMAIL=${GIT_USER_EMAIL:-popebot@example.com}
      - BROWSER_CDP_URL=http://browser:9222
    volumes:
      - ./workspace:/workspace
      - ./auth.json:/root/.pi/agent/auth.json:ro
      - ./secrets.json:/app/secrets.json:ro
    ports:
      - "7681:7681"  # ttyd terminal
    depends_on:
      - browser
    networks:
      - popebot-network

  browser:
    build:
      context: .
      dockerfile: Dockerfile.browser
    container_name: popebot-browser
    environment:
      - BROWSER_CDP_PORT=9222
      - BROWSER_NOVNC_PORT=6080
      - BROWSER_HEADLESS=0
    ports:
      - "6080:6080"  # noVNC web viewer
      - "9222:9222"  # CDP port
    networks:
      - popebot-network

networks:
  popebot-network:
    driver: bridge
